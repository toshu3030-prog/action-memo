<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ—¥æ¬¡è¡Œå‹•ãƒ¡ãƒ¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 16px;
    }
    .card {
      max-width: 640px;
      margin: auto;
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    h1 {
      font-size: 18px;
      margin-bottom: 12px;
    }
    input, textarea, button {
      width: 100%;
      font-size: 16px;
      margin-bottom: 10px;
    }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="date"] {
      line-height: 1.4;
      min-height: 44px; /* iOSã®ã‚¿ãƒƒãƒ—é ˜åŸŸå¯¾ç­– */
    }
    textarea {
      height: 220px;
    }
    button {
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: #007aff;
      color: #fff;
      cursor: pointer;
    }
    .secondary {
      background: #e5e5ea;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ“ æ—¥æ¬¡è¡Œå‹•ãƒ¡ãƒ¢</h1>

    <input type="date" id="date">
    <textarea id="content" placeholder="ä»Šæ—¥ã‚„ã£ãŸã“ã¨ã‚’æ›¸ã"></textarea>

    <button onclick="save()">å…±æœ‰ã—ã¦ä¿å­˜</button>
    <button class="secondary" onclick="load()">éå»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
    <button class="secondary" onclick="makeMonthlyA()">æœˆä¸€è¦§ä½œæˆ</button>
    <button class="secondary" onclick="makeMonthlyB()">æœˆCSVä½œæˆ</button>
    <button class="secondary" onclick="resetApp()">åˆæœŸåŒ–</button>

    <p style="font-size:13px;color:#555;margin-top:8px;">
      â€» ä¿å­˜æ™‚ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã‚’é¸ã³ã€iCloud Drive å†…ã®ä»»æ„ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚<br>
      â€» åŒã˜æ—¥ä»˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ä¿å­˜ã™ã‚‹ã¨ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
    </p>

    <p id="status" style="font-size:13px;color:#555;margin:8px 0 0;"></p>
    <button id="retryShareBtn" class="secondary" style="display:none;" onclick="retryShare()">ã‚‚ã†ä¸€åº¦ å…±æœ‰ã—ã¦ä¿å­˜</button>

    <input type="file" id="file" accept=".txt" hidden>
    <input type="file" id="monthFilesA" accept=".txt" multiple hidden>
    <input type="file" id="monthFilesB" accept=".txt" multiple hidden>
  </div>

  <script>
  const date = document.getElementById('date');
  const content = document.getElementById('content');
  const fileInput = document.getElementById('file');
  const monthFilesInputA = document.getElementById('monthFilesA');
  const monthFilesInputB = document.getElementById('monthFilesB');
  const statusEl = document.getElementById('status');
  const retryShareBtn = document.getElementById('retryShareBtn');

  // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã§å½“æ—¥ã‚»ãƒƒãƒˆ
  const now = new Date();
  date.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

  // å…±æœ‰ãŒå¼¾ã‹ã‚ŒãŸæ™‚ã®å†è©¦è¡Œç”¨
  let pendingShareFiles = null;

  async function shareFiles(files) {
    if (!navigator.share || !navigator.canShare || !navigator.canShare({ files })) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å…±æœ‰ä¿å­˜ãŒä½¿ãˆã¾ã›ã‚“ã€‚iPhone/iPadã®Safariã§è©¦ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    try {
      await navigator.share({ files });
      pendingShareFiles = null;
      if (retryShareBtn) retryShareBtn.style.display = 'none';
      if (statusEl) statusEl.textContent = '';
    } catch (e) {
      // iOS Safari: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®æ–‡è„ˆãŒåˆ‡ã‚Œã‚‹ã¨ NotAllowedError ã§å¼¾ã‹ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹
      pendingShareFiles = files;
      if (retryShareBtn) retryShareBtn.style.display = 'block';
      if (statusEl) statusEl.textContent = 'å…±æœ‰ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚';
    }
  }

  function retryShare() {
    if (pendingShareFiles) shareFiles(pendingShareFiles);
  }

  async function save() {
    if (!content.value.trim()) return alert('å†…å®¹ãŒç©ºã§ã™');
    const file = new File([content.value], `${date.value}.txt`, { type: 'text/plain' });
    await shareFiles([file]);
  }

  function load() {
    fileInput.value = '';
    fileInput.click();
  }

  function makeMonthlyA() {
    monthFilesInputA.value = '';
    monthFilesInputA.click();
  }

  function makeMonthlyB() {
    monthFilesInputB.value = '';
    monthFilesInputB.click();
  }

  // æ—¥æ¬¡ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆèª­ã¿è¾¼ã‚“ã ã‚‰æ—¥ä»˜ã‚‚åˆã‚ã›ã‚‹ï¼‰
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;

    const m = file.name.match(/(\d{4}-\d{2}-\d{2})/);
    if (m) date.value = m[1];

    const reader = new FileReader();
    reader.onload = () => { content.value = String(reader.result ?? ''); };
    reader.onerror = () => alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    reader.readAsText(file);
  };

  async function readDailyFiles(fileList) {
    const files = Array.from(fileList || []);
    if (files.length === 0) return [];

    const items = await Promise.all(files.map(f => new Promise((resolve, reject) => {
      const m = f.name.match(/(\d{4}-\d{2}-\d{2})/);
      if (!m) return reject(new Error('æ—¥ä»˜ãŒå«ã¾ã‚Œãªã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ã™: ' + f.name));

      const r = new FileReader();
      r.onload = () => resolve({
        date: m[1],
        month: m[1].slice(0, 7),
        text: String(r.result ?? '').replace(/\r\n/g, '\n')
      });
      r.onerror = () => reject(new Error('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + f.name));
      r.readAsText(f);
    })));

    const months = Array.from(new Set(items.map(x => x.month)));
    if (months.length !== 1) throw new Error('è¤‡æ•°ã®æœˆãŒæ··ã–ã£ã¦ã„ã¾ã™ï¼ˆ' + months.join(', ') + 'ï¼‰ã€‚1ãƒ¶æœˆåˆ†ã ã‘é¸æŠã—ã¦ãã ã•ã„ã€‚');

    items.sort((a,b) => a.date.localeCompare(b.date));
    return items;
  }

  function buildMonthlyA(items) {
    return items.map(x => {
      const body = (x.text || '').trim();
      return 'â–  ' + x.date + '\n' + (body ? body : '(ç©º)') + '\n';
    }).join('\n');
  }

  function buildMonthlyCSV(items) {
    const csvEscape = (s) => '"' + String(s ?? '').replace(/\r\n/g, '\n').replace(/"/g, '""') + '"';
    const lines = ['date,content'];
    for (const x of items) {
      lines.push(x.date + ',' + csvEscape((x.text || '').trim()));
    }
    return lines.join('\n');
  }

  // æœˆä¸€è¦§ï¼ˆAï¼‰å‡ºåŠ›
  monthFilesInputA.onchange = async () => {
    try {
      const items = await readDailyFiles(monthFilesInputA.files);
      if (items.length === 0) return;
      const ym = items[0].month;
      const fileA = new File([buildMonthlyA(items)], ym + '.txt', { type: 'text/plain' });
      await shareFiles([fileA]);
    } catch (e) {
      alert(e?.message ? String(e.message) : 'æœˆä¸€è¦§ï¼ˆAï¼‰ã®ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  };

  // æœˆCSVï¼ˆBï¼‰å‡ºåŠ›
  monthFilesInputB.onchange = async () => {
    try {
      const items = await readDailyFiles(monthFilesInputB.files);
      if (items.length === 0) return;
      const ym = items[0].month;
      const fileB = new File([buildMonthlyCSV(items)], ym + '.csv', { type: 'text/csv' });
      await shareFiles([fileB]);
    } catch (e) {
      alert(e?.message ? String(e.message) : 'æœˆCSVï¼ˆBï¼‰ã®ä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  };
  function resetApp() {
    // ä»Šæ—¥ã®æ—¥ä»˜ã«æˆ»ã™
    const now = new Date();
    date.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

    // å†…å®¹ã‚¯ãƒªã‚¢
    content.value = '';

    // å…±æœ‰ã®å†è©¦è¡ŒçŠ¶æ…‹ãªã©ã‚‚ãƒªã‚»ãƒƒãƒˆ
    if (typeof pendingShareFiles !== 'undefined') pendingShareFiles = null;
    if (typeof retryShareBtn !== 'undefined' && retryShareBtn) retryShareBtn.style.display = 'none';
    if (typeof statusEl !== 'undefined' && statusEl) statusEl.textContent = '';
  }

</script>
</body>
</html>
