<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ—¥æ¬¡è¡Œå‹•ãƒ¡ãƒ¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 16px;
    }
    .card {
      max-width: 640px;
      margin: auto;
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    h1 {
      font-size: 18px;
      margin-bottom: 12px;
    }
    input, textarea, button {
      width: 100%;
      font-size: 16px;
      margin-bottom: 10px;
    }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="date"] {
      line-height: 1.4;
      min-height: 44px; /* iOSã®ã‚¿ãƒƒãƒ—é ˜åŸŸå¯¾ç­– */
    }
    textarea {
      height: 220px;
    }
    button {
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: #007aff;
      color: #fff;
      cursor: pointer;
    }
    .secondary {
      background: #e5e5ea;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ“ æ—¥æ¬¡è¡Œå‹•ãƒ¡ãƒ¢</h1>

    <input type="date" id="date">
    <textarea id="content" placeholder="ä»Šæ—¥ã‚„ã£ãŸã“ã¨ã‚’æ›¸ã"></textarea>

    <button onclick="save()">å…±æœ‰ã—ã¦ä¿å­˜</button>
    <button class="secondary" onclick="load()">éå»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
    <button class="secondary" onclick="makeMonthly()">æœˆä¸€è¦§ä½œæˆ</button>

    <p style="font-size:13px;color:#555;margin-top:8px;">
      â€» ä¿å­˜æ™‚ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã‚’é¸ã³ã€iCloud Drive å†…ã®ä»»æ„ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚<br>
      â€» åŒã˜æ—¥ä»˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ä¿å­˜ã™ã‚‹ã¨ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
    </p>

    <input type="file" id="file" accept=".txt" hidden>
    <input type="file" id="monthFiles" accept=".txt" multiple hidden>
  </div>
<script>
  const date = document.getElementById('date');
  const content = document.getElementById('content');
  const fileInput = document.getElementById('file');
  const monthFilesInput = document.getElementById('monthFiles');

  // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã§å½“æ—¥ã‚»ãƒƒãƒˆ
  const now = new Date();
  date.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

  async function save() {
    if (!content.value.trim()) return alert('å†…å®¹ãŒç©ºã§ã™');
    const file = new File([content.value], `${date.value}.txt`, { type: 'text/plain' });

    if (navigator.share && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file] });
    } else {
      alert('iPhone / Mac / iPad ã® Safari ã§ä½¿ã£ã¦ãã ã•ã„');
    }
  }

  function load() {
    fileInput.value = '';
    fileInput.click();
  }

  function makeMonthly() {
    monthFilesInput.value = '';
    monthFilesInput.click();
  }

  // æ—¥æ¬¡ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;

    const m = file.name.match(/(\d{4}-\d{2}-\d{2})/);
    if (m) date.value = m[1];

    const reader = new FileReader();
    reader.onload = () => { content.value = String(reader.result ?? ''); };
    reader.onerror = () => alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    reader.readAsText(file);
  };

  // æœˆä¸€è¦§ä½œæˆï¼ˆA+CSVï¼‰
  monthFilesInput.onchange = async () => {
    const files = Array.from(monthFilesInput.files || []);
    if (files.length === 0) return;

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã“ã“ãŒå‹•ã„ã¦ã‚‹ã‹ç¢ºèªï¼ˆå‹•ä½œç¢ºèªã§ããŸã‚‰æ¶ˆã—ã¦OKï¼‰
    // alert(files.length + ' files selected');

    // å…¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    const items = await Promise.all(files.map(f => new Promise((resolve, reject) => {
      const m2 = f.name.match(/(\d{4}-\d{2}-\d{2})/);
      if (!m2) return reject(new Error('æ—¥ä»˜ãŒå«ã¾ã‚Œãªã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ã™: ' + f.name));

      const r = new FileReader();
      r.onload = () => resolve({
        date: m2[1],
        month: m2[1].slice(0, 7),
        text: String(r.result ?? '').replace(/\r\n/g, '\n')
      });
      r.onerror = () => reject(new Error('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + f.name));
      r.readAsText(f);
    })));

    // åŒä¸€æœˆãƒã‚§ãƒƒã‚¯
    const months = Array.from(new Set(items.map(x => x.month)));
    if (months.length !== 1) return alert('è¤‡æ•°ã®æœˆãŒæ··ã–ã£ã¦ã„ã¾ã™ï¼ˆ' + months.join(', ') + 'ï¼‰ã€‚1ãƒ¶æœˆåˆ†ã ã‘é¸æŠã—ã¦ãã ã•ã„ã€‚');
    const ym = months[0];

    // æ—¥ä»˜é †
    items.sort((a,b) => a.date.localeCompare(b.date));

    // Aï¼ˆç¸¦ãƒªã‚¹ãƒˆï¼‰
    const aText = items.map(x => {
      const body = (x.text || '').trim();
      return 'â–  ' + x.date + '\n' + (body ? body : '(ç©º)') + '\n';
    }).join('\n');

    // Bï¼ˆCSVï¼š1æ—¥=1è¡Œï¼‰
    const csvEscape = (s) => '"' + String(s ?? '').replace(/\r\n/g, '\n').replace(/"/g,'""') + '"';
    const csv = ['date,content', ...items.map(x => x.date + ',' + csvEscape((x.text || '').trim()))].join('\n');

    const fileA = new File([aText], ym + '.txt', { type: 'text/plain' });
    const fileB = new File([csv], ym + '.csv', { type: 'text/csv' });

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [fileA, fileB] })) {
      await navigator.share({ files: [fileA, fileB] });
    } else {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ãŒä½¿ãˆã¾ã›ã‚“ã€‚iPhone/iPadã®Safariã§è©¦ã—ã¦ãã ã•ã„ã€‚');
    }
  };
</script>
</body>
</html>
