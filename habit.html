<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; background:#f5f5f7; margin:0; padding:16px; }
  .card { max-width:520px; margin:0 auto; background:#fff; border-radius:16px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
  h1 { font-size:18px; margin:0 0 12px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0; }
  .pill { padding:8px 10px; border-radius:999px; background:#f0f0f3; font-size:14px; }
  label { display:block; margin:12px 0; font-size:16px; }
  input[type="checkbox"]{ transform:scale(1.2); margin-right:10px; }
  .warn { margin-top:10px; padding:10px; border-radius:12px; background:#fff4e5; font-size:14px; }
  .ok { margin-top:10px; padding:10px; border-radius:12px; background:#e9fbef; font-size:14px; }
  button { width:100%; margin-top:12px; padding:12px; border:none; border-radius:12px; font-size:16px; background:#111; color:#fff; }
  .history { margin-top:16px; font-size:14px; }
  ul { padding-left:18px; margin:8px 0 0; }
  li { margin:6px 0; }
  .muted { color:#666; }
</style>
</head>
<body>
<div class="card">
  <h1 id="title">ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>

  <div class="row">
    <div class="pill" id="todayPill"></div>
    <div class="pill" id="weekPill"></div>
  </div>

  <label><input type="checkbox" id="noAlcohol">ä¼‘è‚æ—¥ï¼ˆé…’ã‚’é£²ã¾ãªã‹ã£ãŸï¼‰</label>
  <label><input type="checkbox" id="training">ç­‹ãƒˆãƒ¬é”æˆï¼ˆè…•ç«‹ã¦ï¼‹ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆï¼‰</label>
  <label><input type="checkbox" id="run">ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã—ãŸ</label>

  <div id="statusBox"></div>

  <button id="resetToday">ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

  <div class="history">
    <strong>ç›´è¿‘14æ—¥</strong>
    <div class="muted">ğŸº=é£²é…’æ—¥ / ğŸ“´=ä¼‘è‚æ—¥ / ğŸ’ª=ç­‹ãƒˆãƒ¬ / ğŸƒ=ã‚¸ãƒ§ã‚°</div>
    <ul id="log"></ul>
  </div>
</div>

<script>
  const STORAGE_KEY = "habitLog_v1";

  const $ = (id) => document.getElementById(id);

  const noAlcohol = $("noAlcohol");
  const training = $("training");
  const run = $("run");
  const todayPill = $("todayPill");
  const weekPill = $("weekPill");
  const statusBox = $("statusBox");
  const logEl = $("log");
  const resetTodayBtn = $("resetToday");

  const pad = (n) => String(n).padStart(2, "0");
  const toYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  // ISO week helpers
  function isoWeekKey(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7; // Mon=1..Sun=7
    d.setUTCDate(d.getUTCDate() + 4 - dayNum); // Thursday
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return `${d.getUTCFullYear()}-W${pad(weekNo)}`;
  }

  function startOfISOWeek(date) {
    const d = new Date(date);
    const day = d.getDay(); // Sun=0..Sat=6
    const diff = (day === 0 ? -6 : 1 - day); // move to Monday
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }

  function loadAll() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveAll(obj) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }

  function getDay(all, ymd) {
    return all[ymd] || { noAlcohol:false, training:false, run:false };
  }

  function setDay(all, ymd, patch) {
    all[ymd] = { ...getDay(all, ymd), ...patch };
  }

  // é£²é…’æ—¥ã®å®šç¾©ï¼šä¼‘è‚æ—¥(noAlcohol)ãŒ false ãªã‚‰ã€Œé£²é…’ã—ãŸã€æ‰±ã„
  function isDrinkingDay(dayObj) {
    return !dayObj.noAlcohol;
  }

  function render() {
    const all = loadAll();
    const today = new Date();
    const ymd = toYMD(today);

    todayPill.textContent = `ä»Šæ—¥ï¼š${ymd}`;

    // restore checkboxes from today
    const t = getDay(all, ymd);
    noAlcohol.checked = !!t.noAlcohol;
    training.checked = !!t.training;
    run.checked = !!t.run;

    // weekly count
    const weekKey = isoWeekKey(today);
    const weekStart = startOfISOWeek(today);
    const dates = [];
    for (let i=0;i<7;i++){
      const d = new Date(weekStart);
      d.setDate(weekStart.getDate()+i);
      dates.push(toYMD(d));
    }
    const drinkCount = dates.reduce((acc, d) => {
      const v = getDay(all, d);
      // è¨˜éŒ²ãŒç„¡ã„æ—¥ã¯ã€Œæœªå…¥åŠ›ã€ãªã®ã§é£²é…’ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ï¼ˆã“ã“é‡è¦ï¼‰
      const hasAny = (all[d] !== undefined);
      if (!hasAny) return acc;
      return acc + (isDrinkingDay(v) ? 1 : 0);
    }, 0);

    weekPill.textContent = `ä»Šé€±ã®é£²é…’ï¼š${drinkCount}/4ï¼ˆ${weekKey}ï¼‰`;

    // status message
    statusBox.innerHTML = "";
    if (drinkCount >= 5) {
      statusBox.innerHTML = `<div class="warn">
      âš ï¸ ä»Šé€±ã®é£²é…’ãŒ <strong>${drinkCount}å›</strong> ã«ãªã£ã¦ã„ã¾ã™ï¼ˆä¸Šé™4å›ï¼‰ã€‚
      </div>`;
    } else if (drinkCount === 4) {
    statusBox.innerHTML = `<div class="warn">
      æ³¨æ„ï¼šä»Šé€±ã¯ã™ã§ã« <strong>4å›</strong> é£²ã‚“ã§ã„ã¾ã™ã€‚æ¬¡ã¯ä¼‘è‚æ—¥ã«ã™ã‚‹ã¨ç›®æ¨™é”æˆã§ã™ã€‚
      </div>`;
    } else {
    statusBox.innerHTML = `<div class="ok">
      ã„ã„æ„Ÿã˜ï¼šä»Šé€±ã®é£²é…’ã¯ <strong>${drinkCount}å›</strong> ã§ã™ã€‚
      </div>`;
    }

    // last 14 days list
    const keys = Object.keys(all).sort(); // ymd sort OK
    const last = keys.slice(-14).reverse();

    logEl.innerHTML = "";
    last.forEach(d => {
      const v = getDay(all, d);
      const icons = [];
      icons.push(isDrinkingDay(v) ? "ğŸº" : "ğŸ“´");
      if (v.training) icons.push("ğŸ’ª");
      if (v.run) icons.push("ğŸƒ");
      logEl.innerHTML += `<li>${d}ï¼š${icons.join(" ")}</li>`;
    });
  }

  function onToggle() {
    const all = loadAll();
    const ymd = toYMD(new Date());
    setDay(all, ymd, {
      noAlcohol: noAlcohol.checked,
      training: training.checked,
      run: run.checked
    });
    saveAll(all);
    render();
  }

  noAlcohol.addEventListener("change", onToggle);
  training.addEventListener("change", onToggle);
  run.addEventListener("change", onToggle);

  resetTodayBtn.addEventListener("click", () => {
    const all = loadAll();
    const ymd = toYMD(new Date());
    setDay(all, ymd, { noAlcohol:false, training:false, run:false });
    saveAll(all);
    render();
  });

  render();
</script>
</body>
</html>
